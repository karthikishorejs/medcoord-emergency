<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#2563eb" />
  <meta name="description" content="Kaathu ‚Äì digital medication card with QR sharing" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Kaathu" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' rx='28' fill='%232563eb'/><text x='90' y='125' font-size='110' text-anchor='middle' fill='white'>üíä</text></svg>" />
  <title>Kaathu</title>
  <link rel="manifest" href="/manifest.json" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#2563eb',
            secondary: '#10b981',
            danger: '#ef4444',
            surface: '#f8fafc',
            ink: '#0f172a',
          }
        }
      }
    }
  </script>
  <style>
    /* Elderly-friendly base styles */
    * { -webkit-tap-highlight-color: transparent; }
    body { font-family: system-ui, -apple-system, sans-serif; }
    .btn-touch {
      min-height: 56px;
      min-width: 56px;
      font-size: 1.125rem;
    }
    .screen { display: none; }
    .screen.active { display: flex; }
    /* Camera viewfinder */
    #cameraPreview { max-height: 50vh; object-fit: cover; border-radius: 0.75rem; }
    /* Mic button pulse animations */
    @keyframes micPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
      50% { box-shadow: 0 0 0 12px rgba(16, 185, 129, 0); }
    }
    .mic-idle { animation: micPulse 2s infinite; }
    @keyframes recordPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      50% { box-shadow: 0 0 0 16px rgba(239, 68, 68, 0); }
    }
    .mic-recording { animation: recordPulse 1s infinite; }
  </style>
</head>
<body class="bg-surface text-ink min-h-screen">

  <!-- ============================================ -->
  <!-- SCREEN 1 ‚Äì HOME                             -->
  <!-- ============================================ -->
  <section id="screenHome" class="screen active flex-col items-center justify-center min-h-screen p-6 gap-6">
    <div class="text-center mb-4">
      <span class="text-6xl" aria-hidden="true">üíä</span>
      <h1 class="text-3xl font-bold mt-2 text-primary">Kaathu</h1>
      <p class="text-lg text-ink/70 mt-1">Your Medication Companion</p>
    </div>

    <button onclick="showScreen('screenToday')"
      class="btn-touch w-full max-w-xs bg-amber-500 text-white rounded-2xl px-6 py-4 font-semibold shadow-lg active:scale-95 transition">
      Today's Medications
    </button>

    <button onclick="showScreen('screenMedList')"
      class="btn-touch w-full max-w-xs bg-primary text-white rounded-2xl px-6 py-4 font-semibold shadow-lg active:scale-95 transition">
      My Medications
    </button>

    <button onclick="showScreen('screenCamera')"
      class="btn-touch w-full max-w-xs bg-secondary text-white rounded-2xl px-6 py-4 font-semibold shadow-lg active:scale-95 transition">
      Scan Prescription
    </button>

    <button onclick="generateAndShowQR()"
      class="btn-touch w-full max-w-xs bg-danger text-white rounded-2xl px-6 py-4 font-semibold shadow-lg active:scale-95 transition">
      Show Emergency QR
    </button>
  </section>

  <!-- ============================================ -->
  <!-- SCREEN 2 ‚Äì MEDICATION LIST + ENTRY           -->
  <!-- ============================================ -->
  <section id="screenMedList" class="screen flex-col min-h-screen p-6">
    <header class="flex items-center gap-3 mb-4">
      <button onclick="showScreen('screenHome')" class="btn-touch flex items-center justify-center w-14 h-14 rounded-xl bg-primary/10 text-primary text-2xl" aria-label="Back">‚Üê</button>
      <h2 class="text-2xl font-bold">My Medications</h2>
    </header>

    <!-- ‚îÄ‚îÄ Voice Hero Section ‚îÄ‚îÄ -->
    <div id="voiceHero" class="bg-white rounded-2xl p-6 shadow-lg mb-4 text-center">
      <p id="voiceHint" class="text-lg text-ink/60 mb-4 font-medium">
        Tap the mic and say your medication name
      </p>
      <button id="voiceMicBtn" onclick="toggleRecording()"
        class="w-24 h-24 mx-auto rounded-full bg-secondary text-white text-4xl
               flex items-center justify-center shadow-lg mic-idle
               active:scale-95 transition-all duration-200
               focus:outline-none focus:ring-4 focus:ring-secondary/30"
        aria-label="Tap to record medication">
        üé§
      </button>
      <!-- Recording timer -->
      <p id="voiceTimer" class="hidden text-danger font-bold text-xl mt-3">
        ‚óè Recording... <span id="voiceTimerSeconds">0</span>s
      </p>
      <!-- Processing spinner -->
      <div id="voiceProcessing" class="hidden mt-4">
        <div class="w-8 h-8 mx-auto border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
        <p id="voiceProcessingText" class="text-primary font-semibold mt-2">Converting speech...</p>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Transcript Preview ‚îÄ‚îÄ -->
    <div id="transcriptPreview" class="hidden bg-blue-50 border-2 border-primary/20 rounded-2xl p-5 mb-4">
      <p class="text-sm font-semibold text-primary mb-2">What I heard:</p>
      <p id="transcriptText" class="text-lg text-ink font-medium italic"></p>
      <div class="flex gap-3 mt-4">
        <button onclick="retryVoice()"
          class="btn-touch flex-1 bg-white border-2 border-primary text-primary rounded-xl py-3 font-semibold active:scale-95 transition">
          üîÑ Try Again
        </button>
        <button onclick="useTranscript()"
          class="btn-touch flex-1 bg-primary text-white rounded-xl py-3 font-semibold active:scale-95 transition">
          Use This ‚úì
        </button>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Review Card (after AI parse) ‚Äî shows name + dosage + condition ‚îÄ‚îÄ -->
    <div id="reviewCard" class="hidden bg-green-50 border-2 border-secondary/30 rounded-2xl p-5 mb-4">
      <p class="text-sm font-semibold text-secondary mb-3">Is this correct?</p>
      <div class="space-y-2">
        <div class="flex items-center gap-2">
          <span class="text-xl">üíä</span>
          <p class="text-lg font-bold" id="reviewName">‚Äî</p>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-xl">üì¶</span>
          <p class="text-base text-ink/70" id="reviewDosage">‚Äî</p>
        </div>
        <div id="reviewConditionRow" class="flex items-center gap-2">
          <span class="text-xl">üè•</span>
          <p class="text-base text-primary font-medium" id="reviewCondition">‚Äî</p>
        </div>
      </div>
      <div class="flex gap-3 mt-4">
        <button onclick="editFromReview()"
          class="btn-touch flex-1 bg-white border-2 border-secondary text-secondary rounded-xl py-3 font-semibold active:scale-95 transition">
          ‚úèÔ∏è Edit
        </button>
        <button onclick="goToSchedulePicker()"
          class="btn-touch flex-1 bg-secondary text-white rounded-xl py-3 font-semibold active:scale-95 transition">
          Next ‚Üí
        </button>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Parse Error Card ‚îÄ‚îÄ -->
    <div id="parseErrorCard" class="hidden bg-red-50 border-2 border-danger/30 rounded-2xl p-5 mb-4">
      <div class="flex items-start gap-3">
        <span class="text-3xl flex-shrink-0">üòï</span>
        <div class="flex-1">
          <p class="text-lg font-bold text-danger">Could not understand that</p>
          <p class="text-base text-ink/60 mt-1">I heard:</p>
          <p id="parseErrorTranscript" class="text-base text-ink font-medium italic mt-1 bg-white rounded-lg p-3"></p>
        </div>
      </div>
      <div class="flex gap-3 mt-4">
        <button onclick="retryVoice()"
          class="btn-touch flex-1 bg-danger text-white rounded-xl py-3 font-semibold active:scale-95 transition">
          üé§ Try Again
        </button>
        <button onclick="typeInsteadFromError()"
          class="btn-touch flex-1 bg-white border-2 border-danger text-danger rounded-xl py-3 font-semibold active:scale-95 transition">
          ‚úèÔ∏è Type Instead
        </button>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Schedule Time Picker (shown after name+dosage confirmed) ‚îÄ‚îÄ -->
    <div id="schedulePicker" class="hidden bg-white rounded-2xl p-5 shadow-lg mb-4">
      <p class="text-lg font-bold text-ink mb-1" id="schedulePickerTitle">When do you take this?</p>
      <p class="text-sm text-ink/50 mb-4">Tap all that apply</p>
      <div class="grid grid-cols-4 gap-2 mb-4">
        <button type="button" onclick="toggleScheduleOption(this, '08:00')"
          class="schedule-opt flex flex-col items-center gap-1 p-3 rounded-2xl border-2 border-gray-200 bg-gray-50
                 text-ink/70 font-semibold active:scale-95 transition-all"
          data-time="08:00">
          <span class="text-2xl">üåÖ</span>
          <span class="text-sm">Morning</span>
          <span class="text-xs text-ink/40">8 AM</span>
        </button>
        <button type="button" onclick="toggleScheduleOption(this, '13:00')"
          class="schedule-opt flex flex-col items-center gap-1 p-3 rounded-2xl border-2 border-gray-200 bg-gray-50
                 text-ink/70 font-semibold active:scale-95 transition-all"
          data-time="13:00">
          <span class="text-2xl">‚òÄÔ∏è</span>
          <span class="text-sm">Afternoon</span>
          <span class="text-xs text-ink/40">1 PM</span>
        </button>
        <button type="button" onclick="toggleScheduleOption(this, '20:00')"
          class="schedule-opt flex flex-col items-center gap-1 p-3 rounded-2xl border-2 border-gray-200 bg-gray-50
                 text-ink/70 font-semibold active:scale-95 transition-all"
          data-time="20:00">
          <span class="text-2xl">üåô</span>
          <span class="text-sm">Night</span>
          <span class="text-xs text-ink/40">8 PM</span>
        </button>
        <button type="button" onclick="toggleScheduleOption(this, 'as-needed')"
          class="schedule-opt flex flex-col items-center gap-1 p-3 rounded-2xl border-2 border-gray-200 bg-gray-50
                 text-ink/70 font-semibold active:scale-95 transition-all"
          data-time="as-needed">
          <span class="text-2xl">üíä</span>
          <span class="text-sm">As Needed</span>
          <span class="text-xs text-ink/40">PRN</span>
        </button>
      </div>
      <div class="flex gap-3">
        <button onclick="skipScheduleAndAdd()"
          class="btn-touch flex-1 bg-white border-2 border-gray-300 text-ink/50 rounded-xl py-3 font-semibold active:scale-95 transition">
          Skip
        </button>
        <button onclick="confirmWithSchedule()"
          class="btn-touch flex-1 bg-secondary text-white rounded-xl py-3 font-semibold active:scale-95 transition">
          ‚úì Add Medication
        </button>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Collapsible Manual Form ‚îÄ‚îÄ -->
    <div id="manualEntrySection" class="mb-4">
      <button onclick="toggleManualForm()" type="button"
        class="w-full flex items-center justify-center gap-2 py-3 text-ink/40 font-semibold text-base">
        <span class="w-16 h-px bg-ink/20"></span>
        <span id="manualToggleText">or type it manually</span>
        <span id="manualToggleArrow" class="transition-transform duration-200">‚ñº</span>
        <span class="w-16 h-px bg-ink/20"></span>
      </button>

      <form id="medForm" onsubmit="addMedication(event)"
        class="hidden bg-white rounded-2xl p-5 shadow space-y-4 mt-2">
        <div>
          <label for="medName" class="block font-semibold mb-1 text-lg">Medication Name</label>
          <input id="medName" type="text" required placeholder="e.g. Metformin"
            class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 text-lg focus:border-primary focus:outline-none" />
        </div>
        <div>
          <label for="medDosage" class="block font-semibold mb-1 text-lg">Dosage</label>
          <input id="medDosage" type="text" required placeholder="e.g. 500 mg"
            class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 text-lg focus:border-primary focus:outline-none" />
        </div>

        <button type="submit"
          class="btn-touch w-full bg-primary text-white rounded-xl py-3 font-semibold active:scale-95 transition">
          Next ‚Üí
        </button>
      </form>
    </div>

    <!-- Drug Interaction Summary Card -->
    <div id="interactionSummaryCard" class="hidden mb-4">
      <!-- Loading state -->
      <div id="interactionSummaryLoading" class="hidden bg-blue-50 border-2 border-primary/20 rounded-2xl p-4 flex items-center gap-3">
        <div class="w-6 h-6 border-3 border-primary border-t-transparent rounded-full animate-spin flex-shrink-0"></div>
        <p class="text-primary font-semibold">Checking drug interactions...</p>
      </div>
      <!-- Results state -->
      <div id="interactionSummaryResults" class="hidden rounded-2xl p-5 shadow-lg border-2">
        <div class="flex items-start gap-3">
          <span id="summaryIcon" class="text-3xl flex-shrink-0"></span>
          <div class="flex-1">
            <p id="summaryTitle" class="font-bold text-lg"></p>
            <p id="summaryBreakdown" class="text-sm mt-1 text-ink/60"></p>
          </div>
        </div>
        <button onclick="showAllInteractionsModal()"
          id="summaryReviewBtn"
          class="btn-touch w-full mt-3 bg-white border-2 rounded-xl py-3 font-semibold text-base active:scale-95 transition">
          Review All Interactions
        </button>
      </div>
      <!-- Clean state (no interactions) -->
      <div id="interactionSummaryClean" class="hidden bg-green-50 border-2 border-secondary/20 rounded-2xl p-4 flex items-center gap-3">
        <span class="text-2xl">‚úÖ</span>
        <p class="text-secondary font-semibold">No drug interactions found</p>
      </div>
    </div>

    <!-- Medication list (flash card grid) -->
    <ul id="medListContainer" class="grid grid-cols-2 gap-3 items-start flex-1 overflow-y-auto pb-6"></ul>

    <!-- Empty state -->
    <div id="emptyState" class="flex-1 flex items-center justify-center text-ink/40 text-lg">
      No medications added yet.
    </div>
  </section>

  <!-- ============================================ -->
  <!-- SCREEN 3 ‚Äì CAMERA / PRESCRIPTION SCAN        -->
  <!-- ============================================ -->
  <section id="screenCamera" class="screen flex-col min-h-screen p-6">
    <header class="flex items-center gap-3 mb-6">
      <button onclick="stopCamera(); showScreen('screenHome')" class="btn-touch flex items-center justify-center w-14 h-14 rounded-xl bg-primary/10 text-primary text-2xl" aria-label="Back">‚Üê</button>
      <h2 class="text-2xl font-bold">Scan Prescription</h2>
    </header>

    <video id="cameraPreview" autoplay playsinline class="w-full bg-black rounded-2xl mb-4"></video>

    <!-- Image preview (shown after file upload) -->
    <img id="uploadPreview" class="hidden w-full rounded-2xl mb-4 max-h-[50vh] object-contain bg-gray-100" alt="Uploaded prescription" />

    <div id="cameraError" class="hidden bg-danger/10 text-danger rounded-xl p-4 text-center font-semibold mb-4">
      Unable to access camera. Please allow camera permissions.
    </div>

    <div class="flex gap-3 mb-2">
      <button onclick="capturePhoto()"
        class="btn-touch flex-1 bg-primary text-white rounded-2xl py-4 font-semibold shadow-lg active:scale-95 transition">
        üì∑ Capture
      </button>
      <button onclick="document.getElementById('fileInput').click()"
        class="btn-touch flex-1 bg-secondary text-white rounded-2xl py-4 font-semibold shadow-lg active:scale-95 transition">
        üìé Upload
      </button>
    </div>

    <!-- Hidden file input for gallery/file picker -->
    <input id="fileInput" type="file" accept="image/*" class="hidden" onchange="handleFileUpload(event)" />

    <!-- Extraction result -->
    <div id="extractResult" class="hidden mt-4 bg-white rounded-2xl p-5 shadow">
      <h3 class="font-bold text-lg mb-2">Extracted Medications</h3>
      <div id="extractBody" class="text-lg"></div>
      <button onclick="importExtracted()"
        class="btn-touch w-full mt-4 bg-secondary text-white rounded-xl py-3 font-semibold active:scale-95 transition">
        Import All
      </button>
    </div>

    <!-- Hidden canvas for capture -->
    <canvas id="captureCanvas" class="hidden"></canvas>
  </section>

  <!-- ============================================ -->
  <!-- SCREEN 4 ‚Äì QR CODE DISPLAY                   -->
  <!-- ============================================ -->
  <section id="screenQR" class="screen flex-col items-center justify-center min-h-screen p-6 gap-6">
    <header class="flex items-center gap-3 self-start mb-2">
      <button onclick="showScreen('screenHome')" class="btn-touch flex items-center justify-center w-14 h-14 rounded-xl bg-primary/10 text-primary text-2xl" aria-label="Back">‚Üê</button>
      <h2 class="text-2xl font-bold">Emergency QR</h2>
    </header>

    <div class="bg-white rounded-3xl p-6 shadow-lg">
      <canvas id="qrCanvas"></canvas>
    </div>
    <p class="text-ink/60 text-center text-lg max-w-xs">Show this QR code to an emergency responder so they can see your medications.</p>

    <button onclick="checkInteractions()"
      class="btn-touch w-full max-w-xs bg-secondary text-white rounded-2xl px-6 py-4 font-semibold shadow-lg active:scale-95 transition">
      Check Drug Interactions
    </button>

    <!-- Interactions result -->
    <div id="interactionsResult" class="hidden w-full max-w-xs bg-white rounded-2xl p-5 shadow">
      <h3 class="font-bold text-lg mb-2">Interaction Report</h3>
      <div id="interactionsBody" class="text-base"></div>
    </div>
  </section>

  <!-- ============================================ -->
  <!-- SCREEN 5 ‚Äì TODAY'S MEDICATIONS               -->
  <!-- ============================================ -->
  <section id="screenToday" class="screen flex-col min-h-screen p-6">
    <header class="flex items-center gap-3 mb-4">
      <button onclick="showScreen('screenHome')" class="btn-touch flex items-center justify-center w-14 h-14 rounded-xl bg-primary/10 text-primary text-2xl" aria-label="Back">‚Üê</button>
      <div>
        <h2 class="text-2xl font-bold">Today's Medications</h2>
        <p id="todayDate" class="text-sm text-ink/50 font-semibold"></p>
      </div>
    </header>

    <!-- Today's checklist -->
    <ul id="todayListContainer" class="space-y-3 flex-1 overflow-y-auto pb-2"></ul>

    <!-- As Needed (PRN) section -->
    <div id="todayPrnSection" class="hidden mb-4">
      <p class="text-sm font-semibold text-ink/40 uppercase tracking-wide mb-2 mt-2">üíä As Needed</p>
      <ul id="todayPrnContainer" class="space-y-2"></ul>
    </div>

    <!-- Empty state -->
    <div id="todayEmptyState" class="flex-1 flex flex-col items-center justify-center text-center gap-3">
      <p class="text-ink/40 text-lg">No medications for today.</p>
      <button onclick="showScreen('screenMedList')"
        class="text-primary font-semibold text-lg underline">
        Add medications
      </button>
    </div>
  </section>

  <!-- ============================================ -->
  <!-- LOADING OVERLAY                              -->
  <!-- ============================================ -->
  <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 flex flex-col items-center gap-4 shadow-xl">
      <div class="w-10 h-10 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
      <p id="loadingText" class="text-lg font-semibold">Processing...</p>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- INTERACTION DETAIL MODAL                     -->
  <!-- ============================================ -->
  <div id="interactionModal" class="hidden fixed inset-0 bg-black/50 flex items-end sm:items-center justify-center z-50 p-0 sm:p-6">
    <div class="bg-white rounded-t-3xl sm:rounded-3xl w-full max-w-md max-h-[85vh] overflow-y-auto shadow-2xl">
      <div class="sticky top-0 bg-white rounded-t-3xl border-b border-gray-100 p-5 flex items-center justify-between">
        <h3 id="modalTitle" class="text-xl font-bold">Interaction Details</h3>
        <button onclick="closeInteractionModal()"
          class="btn-touch w-12 h-12 flex items-center justify-center rounded-full bg-gray-100 text-ink text-xl"
          aria-label="Close">√ó</button>
      </div>
      <div class="p-5 space-y-4">
        <div id="modalSeverityBadge" class="flex items-center gap-2">
          <span id="modalSeverityIcon" class="text-2xl"></span>
          <span id="modalSeverityText" class="text-lg font-bold px-3 py-1 rounded-full"></span>
        </div>
        <div class="bg-gray-50 rounded-xl p-4">
          <p class="text-sm font-semibold text-ink/50 mb-1">Interacting Medications</p>
          <p id="modalPair" class="text-lg font-bold"></p>
        </div>
        <div>
          <p class="text-sm font-semibold text-ink/50 mb-1">Description</p>
          <p id="modalDescription" class="text-base text-ink/80 leading-relaxed"></p>
        </div>
        <div class="bg-blue-50 rounded-xl p-4">
          <p class="text-sm font-semibold text-primary mb-2">Recommendations</p>
          <ul id="modalRecommendations" class="text-sm text-ink/70 space-y-1 list-disc list-inside"></ul>
        </div>
        <div class="bg-gray-50 rounded-xl p-3">
          <p class="text-xs text-ink/40 leading-snug">
            This information is for reference only. Always consult your doctor or pharmacist about drug interactions.
          </p>
        </div>
      </div>
      <div class="sticky bottom-0 bg-white border-t border-gray-100 p-5">
        <button onclick="closeInteractionModal()"
          class="btn-touch w-full bg-primary text-white rounded-xl py-3 font-semibold active:scale-95 transition">
          Dismiss
        </button>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- ALL INTERACTIONS MODAL                       -->
  <!-- ============================================ -->
  <div id="allInteractionsModal" class="hidden fixed inset-0 bg-black/50 flex items-end sm:items-center justify-center z-50 p-0 sm:p-6">
    <div class="bg-white rounded-t-3xl sm:rounded-3xl w-full max-w-md max-h-[85vh] overflow-y-auto shadow-2xl">
      <div class="sticky top-0 bg-white rounded-t-3xl border-b border-gray-100 p-5 flex items-center justify-between">
        <h3 class="text-xl font-bold">All Drug Interactions</h3>
        <button onclick="closeAllInteractionsModal()"
          class="btn-touch w-12 h-12 flex items-center justify-center rounded-full bg-gray-100 text-ink text-xl"
          aria-label="Close">√ó</button>
      </div>
      <div id="allInteractionsBody" class="p-5 space-y-3"></div>
      <div class="sticky bottom-0 bg-white border-t border-gray-100 p-5">
        <button onclick="closeAllInteractionsModal()"
          class="btn-touch w-full bg-primary text-white rounded-xl py-3 font-semibold active:scale-95 transition">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- APPLICATION LOGIC                            -->
  <!-- ============================================ -->
  <script>
    // ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let medications = JSON.parse(localStorage.getItem('kaathu_meds') || '[]');
    let cameraStream = null;
    let extractedMeds = [];
    let cachedInteractions = [];
    let interactionCheckInProgress = false;
    const INTERACTION_CACHE_KEY = 'kaathu_interactions';
    const INTERACTION_CACHE_TTL = 24 * 60 * 60 * 1000; // 24 hours

    let todayRefreshInterval = null;

    // ‚îÄ‚îÄ Interaction Cache (localStorage + 24h expiry) ‚îÄ‚îÄ
    function getMedFingerprint() {
      return medications.map(m => m.name.toLowerCase().trim()).sort().join('|');
    }

    function loadCachedInteractions() {
      try {
        const raw = localStorage.getItem(INTERACTION_CACHE_KEY);
        if (!raw) return [];
        const cached = JSON.parse(raw);
        if (Date.now() - cached.timestamp > INTERACTION_CACHE_TTL) {
          localStorage.removeItem(INTERACTION_CACHE_KEY);
          return [];
        }
        if (cached.medKey !== getMedFingerprint()) {
          localStorage.removeItem(INTERACTION_CACHE_KEY);
          return [];
        }
        return cached.interactions || [];
      } catch { return []; }
    }

    function saveCachedInteractions(interactions) {
      localStorage.setItem(INTERACTION_CACHE_KEY, JSON.stringify({
        timestamp: Date.now(),
        medKey: getMedFingerprint(),
        interactions: interactions,
      }));
    }

    function invalidateInteractionCache() {
      localStorage.removeItem(INTERACTION_CACHE_KEY);
    }

    // ‚îÄ‚îÄ Drug ‚Üí Condition (AI-powered) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // In-memory cache: drug name (lowercase) ‚Üí condition string
    const conditionCache = {};

    // Synchronous cache-only lookup (returns '' if not cached)
    function lookupCondition(drugName) {
      if (!drugName) return '';
      return conditionCache[drugName.toLowerCase().trim()] || '';
    }

    // Async: fetch condition for a single drug via AI, with cache
    async function fetchCondition(drugName) {
      if (!drugName) return '';
      const key = drugName.toLowerCase().trim();
      if (conditionCache[key]) return conditionCache[key];
      try {
        const res = await fetch('/api/drug-condition', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ medications: [drugName] }),
        });
        if (!res.ok) return '';
        const data = await res.json();
        const conditions = data.conditions || {};
        // Cache all returned conditions (API returns exact name keys)
        for (const [name, cond] of Object.entries(conditions)) {
          conditionCache[name.toLowerCase().trim()] = cond;
        }
        return conditionCache[key] || '';
      } catch { return ''; }
    }

    // Async: batch-fetch conditions for multiple drugs in one API call
    async function fetchConditions(drugNames) {
      // Filter out already-cached ones
      const uncached = drugNames.filter(n => !conditionCache[n.toLowerCase().trim()]);
      if (uncached.length === 0) return;
      try {
        const res = await fetch('/api/drug-condition', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ medications: uncached }),
        });
        if (!res.ok) return;
        const data = await res.json();
        const conditions = data.conditions || {};
        for (const [name, cond] of Object.entries(conditions)) {
          conditionCache[name.toLowerCase().trim()] = cond;
        }
      } catch { /* silently fail ‚Äî conditions are optional */ }
    }

    // ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      if (id === 'screenMedList') { renderMedList(); renderInteractionSummary(); }
      if (id === 'screenCamera') initCamera();
      if (id === 'screenToday') {
        renderTodayList();
        // Auto-refresh every 60s so status badges update live
        if (todayRefreshInterval) clearInterval(todayRefreshInterval);
        todayRefreshInterval = setInterval(renderTodayList, 60000);
      } else {
        if (todayRefreshInterval) { clearInterval(todayRefreshInterval); todayRefreshInterval = null; }
      }
    }

    // ‚îÄ‚îÄ Persistence ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function saveMeds() {
      localStorage.setItem('kaathu_meds', JSON.stringify(medications));
    }

    // ‚îÄ‚îÄ Medication CRUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function addMedication(e) {
      e.preventDefault();
      const name = document.getElementById('medName').value.trim();
      const dosage = document.getElementById('medDosage').value.trim();
      if (!name || !dosage) return;
      // Store pending med and show schedule picker
      currentParsedMed = { name, dosage, condition: '' };
      // Try to get condition from cache
      const cached = lookupCondition(name);
      if (cached) currentParsedMed.condition = cached;
      // Fetch condition from AI in background
      if (!currentParsedMed.condition) {
        fetchCondition(name).then(cond => {
          if (cond && currentParsedMed) currentParsedMed.condition = cond;
        });
      }
      showSchedulePicker(name);
    }

    function removeMedication(id) {
      medications = medications.filter(m => m.id !== id);
      saveMeds();
      renderMedList();
      invalidateInteractionCache();
      checkAndDisplayInteractions();
    }

    function renderMedList() {
      const container = document.getElementById('medListContainer');
      const empty = document.getElementById('emptyState');
      if (medications.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');
      container.innerHTML = medications.map(m => {
        // Find interactions involving this medication
        const medInteractions = cachedInteractions.filter(i =>
          i.pair.toLowerCase().includes(m.name.toLowerCase())
        );
        const count = medInteractions.length;
        const hasSevere = medInteractions.some(i => i.severity === 'Severe');
        const hasModerate = medInteractions.some(i => i.severity === 'Moderate');
        const borderClass = count > 0
          ? (hasSevere ? 'border-danger' : 'border-yellow-500')
          : 'border-primary';

        // Interaction count badge (top-left)
        let badgeHtml = '';
        if (count > 0) {
          const badgeBg = hasSevere ? 'bg-danger' : (hasModerate ? 'bg-yellow-500' : 'bg-yellow-400');
          badgeHtml = `<span class="absolute top-2 left-2 ${badgeBg} text-white text-xs font-bold px-2 py-1 rounded-full leading-none">‚ö†Ô∏è ${count}</span>`;
        } else if (cachedInteractions.length > 0) {
          badgeHtml = `<span class="absolute top-2 left-2 bg-secondary text-white text-xs font-bold px-2 py-1 rounded-full leading-none">‚úì</span>`;
        }

        // Expandable interaction section
        let expandHtml = '';
        if (count > 0) {
          const items = medInteractions.map((interaction, idx) => {
            const otherDrug = interaction.pair.split(' + ')
              .find(p => p.toLowerCase() !== m.name.toLowerCase()) || interaction.pair.split(' + ')[0];
            const sevColor = interaction.severity === 'Severe' ? 'text-danger' :
                             interaction.severity === 'Moderate' ? 'text-yellow-700' : 'text-ink/60';
            const sevBg = interaction.severity === 'Severe' ? 'bg-danger/10' :
                          interaction.severity === 'Moderate' ? 'bg-yellow-50' : 'bg-gray-50';
            const shortDesc = interaction.description.length > 80
              ? interaction.description.substring(0, 80) + '...'
              : interaction.description;
            return `
              <div class="${sevBg} rounded-xl p-3 mb-2">
                <div class="flex items-center justify-between mb-1">
                  <p class="font-bold text-sm">${esc(otherDrug)}</p>
                  <span class="${sevColor} text-xs font-bold px-2 py-0.5 rounded-full border border-current/20">${esc(interaction.severity)}</span>
                </div>
                <p class="text-xs text-ink/60 leading-snug">${esc(shortDesc)}</p>
                <button onclick="event.stopPropagation(); showInteractionDetail(${m.id}, ${idx})"
                  class="text-primary text-xs font-bold mt-2 underline active:opacity-70">
                  Learn More
                </button>
              </div>`;
          }).join('');

          expandHtml = `
            <div class="mt-2 w-full text-left">
              <button onclick="toggleInteractionExpand(${m.id})"
                class="w-full text-center text-xs font-bold py-2 rounded-lg active:bg-gray-100 transition
                       ${hasSevere ? 'text-danger' : 'text-yellow-700'}">
                <span id="expandArrow_${m.id}" class="inline-block transition-transform duration-200">‚ñº</span>
                View Interactions (${count})
              </button>
              <div id="expandSection_${m.id}" class="hidden mt-2">
                ${items}
              </div>
            </div>`;
        }

        return `
        <li class="bg-white rounded-2xl p-4 shadow-md relative flex flex-col items-center text-center min-h-[120px] justify-center border-l-4 ${borderClass}">
          <button onclick="removeMedication(${m.id})" class="absolute top-2 right-2 w-7 h-7 flex items-center justify-center rounded-full bg-danger/10 text-danger text-sm" aria-label="Remove">√ó</button>
          ${badgeHtml}
          <p class="font-bold text-base leading-tight mt-1">${esc(m.name)}</p>
          ${m.condition ? `<p class="text-xs mt-0.5 px-2 py-0.5 rounded-full bg-primary/10 text-primary font-medium">${esc(m.condition)}</p>` : ''}
          <p class="text-primary font-semibold text-sm mt-1">${esc(m.dosage)}</p>
          ${m.scheduledTimes && m.scheduledTimes.length > 0 ? `<p class="text-ink/40 text-xs mt-1">‚è∞ ${m.scheduledTimes.map(formatTime12h).join(', ')}</p>` : ''}
          ${m.asNeeded ? `<p class="text-xs mt-0.5 px-2 py-0.5 rounded-full bg-amber-50 text-amber-600 font-medium">As Needed</p>` : ''}
          ${expandHtml}
        </li>`;
      }).join('');
    }

    function toggleInteractionExpand(medId) {
      const section = document.getElementById('expandSection_' + medId);
      const arrow = document.getElementById('expandArrow_' + medId);
      if (!section) return;
      if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        if (arrow) arrow.style.transform = 'rotate(180deg)';
      } else {
        section.classList.add('hidden');
        if (arrow) arrow.style.transform = '';
      }
    }

    // ‚îÄ‚îÄ Drug Interaction Check (background, cached) ‚îÄ‚îÄ
    async function checkAndDisplayInteractions() {
      if (medications.length < 2) {
        cachedInteractions = [];
        invalidateInteractionCache();
        renderMedList();
        renderInteractionSummary();
        return;
      }

      // Try loading from localStorage cache first
      const fromCache = loadCachedInteractions();
      if (fromCache.length > 0) {
        cachedInteractions = fromCache;
        renderMedList();
        renderInteractionSummary();
        return;
      }

      // Show loading state
      interactionCheckInProgress = true;
      renderInteractionSummary();

      try {
        const names = medications.map(m => m.name);
        const res = await fetch('/api/drug-interactions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ medications: names }),
        });
        if (!res.ok) throw new Error('Interaction check failed');
        const data = await res.json();
        cachedInteractions = data.interactions || [];
        saveCachedInteractions(cachedInteractions);
      } catch {
        // Silently fail ‚Äî keep any existing cachedInteractions
      } finally {
        interactionCheckInProgress = false;
        renderMedList();
        renderInteractionSummary();
      }
    }

    // ‚îÄ‚îÄ Interaction Summary Rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderInteractionSummary() {
      const card = document.getElementById('interactionSummaryCard');
      const loading = document.getElementById('interactionSummaryLoading');
      const results = document.getElementById('interactionSummaryResults');
      const clean = document.getElementById('interactionSummaryClean');

      loading.classList.add('hidden');
      results.classList.add('hidden');
      clean.classList.add('hidden');

      if (medications.length < 2) { card.classList.add('hidden'); return; }
      card.classList.remove('hidden');

      if (interactionCheckInProgress) { loading.classList.remove('hidden'); return; }

      if (cachedInteractions.length === 0) { clean.classList.remove('hidden'); return; }

      // Count by severity
      const severe = cachedInteractions.filter(i => i.severity === 'Severe').length;
      const moderate = cachedInteractions.filter(i => i.severity === 'Moderate').length;
      const mild = cachedInteractions.filter(i => i.severity === 'Mild').length;
      const total = cachedInteractions.length;
      const hasSevere = severe > 0;

      // Style the card
      results.className = hasSevere
        ? 'rounded-2xl p-5 shadow-lg border-2 bg-red-50 border-danger/30'
        : 'rounded-2xl p-5 shadow-lg border-2 bg-yellow-50 border-yellow-400/30';

      document.getElementById('summaryIcon').textContent = hasSevere ? 'üö®' : '‚ö†Ô∏è';

      const titleEl = document.getElementById('summaryTitle');
      titleEl.textContent = `Found ${total} drug interaction${total > 1 ? 's' : ''} across your medications`;
      titleEl.className = `font-bold text-lg ${hasSevere ? 'text-danger' : 'text-yellow-700'}`;

      const parts = [];
      if (severe > 0) parts.push(`${severe} severe`);
      if (moderate > 0) parts.push(`${moderate} moderate`);
      if (mild > 0) parts.push(`${mild} mild`);
      document.getElementById('summaryBreakdown').textContent = parts.join(', ');

      const btn = document.getElementById('summaryReviewBtn');
      btn.className = hasSevere
        ? 'btn-touch w-full mt-3 bg-white border-2 border-danger text-danger rounded-xl py-3 font-semibold text-base active:scale-95 transition'
        : 'btn-touch w-full mt-3 bg-white border-2 border-yellow-600 text-yellow-700 rounded-xl py-3 font-semibold text-base active:scale-95 transition';

      results.classList.remove('hidden');
    }

    // ‚îÄ‚îÄ Interaction Modals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showInteractionDetail(medId, interactionIndex) {
      const med = medications.find(m => m.id === medId);
      if (!med) return;
      const medInteractions = cachedInteractions.filter(i =>
        i.pair.toLowerCase().includes(med.name.toLowerCase())
      );
      const interaction = medInteractions[interactionIndex];
      if (!interaction) return;

      document.getElementById('modalPair').textContent = interaction.pair;
      document.getElementById('modalDescription').textContent = interaction.description;

      const sevIcon = document.getElementById('modalSeverityIcon');
      const sevText = document.getElementById('modalSeverityText');
      if (interaction.severity === 'Severe') {
        sevIcon.textContent = 'üö®';
        sevText.textContent = 'Severe';
        sevText.className = 'text-lg font-bold px-3 py-1 rounded-full bg-danger/10 text-danger';
      } else if (interaction.severity === 'Moderate') {
        sevIcon.textContent = '‚ö†Ô∏è';
        sevText.textContent = 'Moderate';
        sevText.className = 'text-lg font-bold px-3 py-1 rounded-full bg-yellow-50 text-yellow-700';
      } else {
        sevIcon.textContent = '‚ÑπÔ∏è';
        sevText.textContent = 'Mild';
        sevText.className = 'text-lg font-bold px-3 py-1 rounded-full bg-blue-50 text-primary';
      }

      const recs = document.getElementById('modalRecommendations');
      const recommendations = interaction.severity === 'Severe'
        ? ['Consult your doctor before taking these together',
           'Do not stop any medication without medical advice',
           'Seek immediate medical attention if you experience adverse effects']
        : interaction.severity === 'Moderate'
        ? ['Inform your doctor about this combination',
           'Monitor for unusual side effects',
           'Consider adjusting timing of doses if advised']
        : ['Generally safe, but inform your pharmacist',
           'Watch for minor side effects'];
      recs.innerHTML = recommendations.map(r => `<li>${esc(r)}</li>`).join('');

      document.getElementById('interactionModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeInteractionModal() {
      document.getElementById('interactionModal').classList.add('hidden');
      document.body.style.overflow = '';
    }

    function showAllInteractionsModal() {
      const body = document.getElementById('allInteractionsBody');
      if (cachedInteractions.length === 0) {
        body.innerHTML = '<p class="text-ink/50 text-center py-4">No interactions found.</p>';
      } else {
        const sorted = [...cachedInteractions].sort((a, b) => {
          const order = { Severe: 0, Moderate: 1, Mild: 2 };
          return (order[a.severity] || 2) - (order[b.severity] || 2);
        });
        body.innerHTML = sorted.map(interaction => {
          const sevColor = interaction.severity === 'Severe' ? 'border-danger bg-red-50' :
                           interaction.severity === 'Moderate' ? 'border-yellow-400 bg-yellow-50' :
                           'border-gray-200 bg-gray-50';
          const sevTextColor = interaction.severity === 'Severe' ? 'text-danger' :
                               interaction.severity === 'Moderate' ? 'text-yellow-700' : 'text-ink/60';
          return `
            <div class="border-2 ${sevColor} rounded-xl p-4">
              <div class="flex items-center justify-between mb-2">
                <p class="font-bold text-base">${esc(interaction.pair)}</p>
                <span class="${sevTextColor} text-xs font-bold">${esc(interaction.severity)}</span>
              </div>
              <p class="text-sm text-ink/70">${esc(interaction.description)}</p>
            </div>`;
        }).join('');
      }
      document.getElementById('allInteractionsModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeAllInteractionsModal() {
      document.getElementById('allInteractionsModal').classList.add('hidden');
      document.body.style.overflow = '';
    }

    // Backdrop click-to-close for modals
    document.getElementById('interactionModal').addEventListener('click', function(e) {
      if (e.target === this) closeInteractionModal();
    });
    document.getElementById('allInteractionsModal').addEventListener('click', function(e) {
      if (e.target === this) closeAllInteractionsModal();
    });

    // ‚îÄ‚îÄ Camera ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function initCamera() {
      const video = document.getElementById('cameraPreview');
      const errEl = document.getElementById('cameraError');
      errEl.classList.add('hidden');
      document.getElementById('extractResult').classList.add('hidden');
      // Reset upload preview and show video
      document.getElementById('uploadPreview').classList.add('hidden');
      document.getElementById('cameraPreview').classList.remove('hidden');
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
        });
        video.srcObject = cameraStream;
      } catch {
        errEl.classList.remove('hidden');
      }
    }

    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(t => t.stop());
        cameraStream = null;
      }
    }

    async function capturePhoto() {
      const video = document.getElementById('cameraPreview');
      const canvas = document.getElementById('captureCanvas');
      if (!cameraStream) return;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
      stopCamera();
      await extractPrescription(dataUrl);
    }

    // ‚îÄ‚îÄ File Upload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      stopCamera();
      // Hide video, show image preview
      document.getElementById('cameraPreview').classList.add('hidden');
      const preview = document.getElementById('uploadPreview');
      const reader = new FileReader();
      reader.onload = async (e) => {
        const dataUrl = e.target.result;
        preview.src = dataUrl;
        preview.classList.remove('hidden');
        await extractPrescription(dataUrl);
      };
      reader.readAsDataURL(file);
      // Reset file input so the same file can be re-selected
      event.target.value = '';
    }

    // ‚îÄ‚îÄ Image Compression ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Resize and compress to JPEG so it stays under Vercel's 4.5MB body limit
    function compressImage(dataUrl, maxWidth = 1200, quality = 0.7) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let w = img.width, h = img.height;
          if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
          canvas.width = w;
          canvas.height = h;
          canvas.getContext('2d').drawImage(img, 0, 0, w, h);
          resolve(canvas.toDataURL('image/jpeg', quality));
        };
        img.src = dataUrl;
      });
    }

    // ‚îÄ‚îÄ Prescription OCR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function extractPrescription(imageDataUrl) {
      showLoading('Extracting medications...');
      try {
        // Always compress to JPEG to keep payload small & MIME consistent
        const compressed = await compressImage(imageDataUrl);
        const base64 = compressed.split(',')[1];
        const mimeType = 'image/jpeg';

        const res = await fetch('/api/extract-prescription', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: base64, mimeType }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Extraction failed');
        extractedMeds = data.medications || [];
        const body = document.getElementById('extractBody');
        if (extractedMeds.length === 0) {
          body.innerHTML = '<p class="text-ink/50">No medications detected. Try a clearer photo.</p>';
        } else {
          body.innerHTML = extractedMeds.map(m => {
            const times = m.pattern ? patternToScheduledTimes(m.pattern) : [];
            const timeStr = times.length > 0 ? times.map(formatTime12h).join(', ') : '';
            const isDuplicate = medications.some(existing =>
              existing.name.toLowerCase().trim() === m.name.toLowerCase().trim() &&
              existing.dosage.toLowerCase().trim() === m.dosage.toLowerCase().trim()
            );
            const conditionLabel = m.condition || lookupCondition(m.name);
            return `<div class="py-2 border-b last:border-0 ${isDuplicate ? 'opacity-50' : ''}">
              <p><strong>${esc(m.name)}</strong> ‚Äî ${esc(m.dosage)}${isDuplicate ? ' <span class="text-amber-600 text-sm font-semibold">(already exists)</span>' : ''}</p>
              ${conditionLabel ? `<p class="text-primary/70 text-sm font-medium">For: ${esc(conditionLabel)}</p>` : ''}
              ${m.instructions ? `<p class="text-ink/70 text-base">${esc(m.instructions)}</p>` : ''}
              ${m.pattern ? `<p class="text-ink/40 text-sm">Pattern: ${esc(m.pattern)} (M-A-N)${timeStr ? ' ‚Üí ' + timeStr : ''}</p>` : ''}
            </div>`;
          }).join('');
        }
        document.getElementById('extractResult').classList.remove('hidden');
      } catch (err) {
        alert('Could not extract medications: ' + err.message);
        console.error(err);
      } finally {
        hideLoading();
      }
    }

    // Infer scheduledTimes from instructions/dosage text when no explicit times are set
    // "twice daily" ‚Üí ["08:00", "20:00"], "once daily in the morning" ‚Üí ["08:00"]
    function inferScheduledTimes(med) {
      // Already has explicit times
      if (med.scheduledTimes && med.scheduledTimes.length > 0) return med.scheduledTimes;

      // PRN-only meds (as needed, no scheduled times) ‚Üí don't assign times
      if (med.asNeeded) return [];

      const text = ((med.instructions || '') + ' ' + (med.dosage || '')).toLowerCase();

      // Has M-A-N pattern
      if (med.pattern) {
        const times = patternToScheduledTimes(med.pattern);
        if (times.length > 0) return times;
      }

      // Check for specific time-of-day keywords
      const hasMorning = /\b(morning|breakfast|before food am)\b/i.test(text);
      const hasAfternoon = /\b(afternoon|lunch|midday|noon)\b/i.test(text);
      const hasNight = /\b(night|evening|dinner|bedtime|bed time|before sleep|pm)\b/i.test(text);

      if (hasMorning || hasAfternoon || hasNight) {
        const times = [];
        if (hasMorning) times.push('08:00');
        if (hasAfternoon) times.push('13:00');
        if (hasNight) times.push('20:00');
        return times;
      }

      // Check for frequency keywords
      if (/\b(three times|thrice|3 times|tds|tid)\b/i.test(text)) return ['08:00', '13:00', '20:00'];
      if (/\b(twice|two times|2 times|bid|bd)\b/i.test(text)) return ['08:00', '20:00'];
      if (/\b(once|one time|1 time|daily|od|every day)\b/i.test(text)) return ['08:00'];

      // Default: show once daily at morning so it still appears on Today screen
      return ['08:00'];
    }

    // Convert M-A-N dosing pattern to scheduledTimes array
    // "1-0-1" ‚Üí ["08:00", "20:00"], "1-1-1" ‚Üí ["08:00", "13:00", "20:00"]
    function patternToScheduledTimes(pattern) {
      if (!pattern) return [];
      const parts = pattern.split('-').map(Number);
      if (parts.length !== 3) return [];
      const times = [];
      if (parts[0] >= 1) times.push('08:00');  // Morning (before 10 AM)
      if (parts[1] >= 1) times.push('13:00');  // Afternoon (12‚Äì3 PM)
      if (parts[2] >= 1) times.push('20:00');  // Evening (7‚Äì10 PM)
      return times;
    }

    function importExtracted() {
      let imported = 0, skipped = 0;
      extractedMeds.forEach(m => {
        // Check for duplicate: same name (case-insensitive) AND same dosage
        const isDuplicate = medications.some(existing =>
          existing.name.toLowerCase().trim() === m.name.toLowerCase().trim() &&
          existing.dosage.toLowerCase().trim() === m.dosage.toLowerCase().trim()
        );
        if (isDuplicate) { skipped++; return; }

        const med = { id: Date.now() + Math.random(), ...m };
        // Auto-fill condition from cache if OCR didn't provide one
        if (!med.condition) {
          const cached = lookupCondition(med.name);
          if (cached) med.condition = cached;
        }
        // Auto-generate scheduledTimes from M-A-N pattern if present
        if (m.pattern) {
          const times = patternToScheduledTimes(m.pattern);
          if (times.length > 0) med.scheduledTimes = times;
        }
        medications.push(med);
        imported++;
      });
      saveMeds();
      extractedMeds = [];
      // Show feedback if duplicates were skipped
      if (skipped > 0) {
        alert(`Imported ${imported} medication(s). Skipped ${skipped} duplicate(s) already in your list.`);
      }
      showScreen('screenMedList');
      invalidateInteractionCache();
      checkAndDisplayInteractions();
      // Batch-fetch conditions from AI for any meds still missing condition
      const needsCondition = medications.filter(m => !m.condition).map(m => m.name);
      if (needsCondition.length > 0) {
        fetchConditions(needsCondition).then(() => {
          let updated = false;
          medications.forEach(m => {
            if (!m.condition) {
              const cond = lookupCondition(m.name);
              if (cond) { m.condition = cond; updated = true; }
            }
          });
          if (updated) { saveMeds(); renderMedList(); }
        });
      }
    }

    // ‚îÄ‚îÄ Schedule Time Picker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let _selectedScheduleTimes = [];

    function showSchedulePicker(medName) {
      _selectedScheduleTimes = [];
      // Reset all schedule option buttons
      document.querySelectorAll('.schedule-opt').forEach(btn => {
        btn.classList.remove('border-secondary', 'bg-secondary/10', 'text-secondary');
        btn.classList.add('border-gray-200', 'bg-gray-50', 'text-ink/70');
      });
      document.getElementById('schedulePickerTitle').textContent = `When do you take ${medName}?`;
      document.getElementById('schedulePicker').classList.remove('hidden');
      document.getElementById('schedulePicker').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function toggleScheduleOption(btn, time) {
      const idx = _selectedScheduleTimes.indexOf(time);
      if (idx === -1) {
        _selectedScheduleTimes.push(time);
        btn.classList.remove('border-gray-200', 'bg-gray-50', 'text-ink/70');
        btn.classList.add('border-secondary', 'bg-secondary/10', 'text-secondary');
      } else {
        _selectedScheduleTimes.splice(idx, 1);
        btn.classList.remove('border-secondary', 'bg-secondary/10', 'text-secondary');
        btn.classList.add('border-gray-200', 'bg-gray-50', 'text-ink/70');
      }
    }

    function confirmWithSchedule() {
      if (!currentParsedMed) return;
      const med = {
        id: Date.now(),
        name: currentParsedMed.name,
        dosage: currentParsedMed.dosage,
      };
      if (currentParsedMed.condition) med.condition = currentParsedMed.condition;
      // Separate "as-needed" from actual times
      const hasAsNeeded = _selectedScheduleTimes.includes('as-needed');
      const actualTimes = _selectedScheduleTimes.filter(t => t !== 'as-needed').sort();
      if (actualTimes.length > 0) med.scheduledTimes = actualTimes;
      if (hasAsNeeded) med.asNeeded = true;
      finalizeAddMed(med);
    }

    function skipScheduleAndAdd() {
      if (!currentParsedMed) return;
      const med = {
        id: Date.now(),
        name: currentParsedMed.name,
        dosage: currentParsedMed.dosage,
      };
      if (currentParsedMed.condition) med.condition = currentParsedMed.condition;
      finalizeAddMed(med);
    }

    function finalizeAddMed(med) {
      medications.push(med);
      saveMeds();
      renderMedList();
      invalidateInteractionCache();
      checkAndDisplayInteractions();

      // If condition is missing, fetch from AI in background
      if (!med.condition) {
        fetchCondition(med.name).then(cond => {
          if (cond) {
            const found = medications.find(m => m.id === med.id);
            if (found && !found.condition) { found.condition = cond; saveMeds(); renderMedList(); }
          }
        });
      }

      // Cache condition
      if (med.name && med.condition) {
        conditionCache[med.name.toLowerCase().trim()] = med.condition;
      }

      // Hide schedule picker and manual form
      document.getElementById('schedulePicker').classList.add('hidden');
      document.getElementById('medForm')?.reset();
      document.getElementById('medForm')?.classList.add('hidden');
      document.getElementById('manualToggleArrow').style.transform = '';

      // Show success toast
      showSuccessToast(med.name);
      resetVoiceState();
    }

    // ‚îÄ‚îÄ Manual Form Toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleManualForm() {
      const form = document.getElementById('medForm');
      const arrow = document.getElementById('manualToggleArrow');
      if (form.classList.contains('hidden')) {
        expandManualForm();
      } else {
        form.classList.add('hidden');
        arrow.style.transform = '';
      }
    }
    function expandManualForm() {
      document.getElementById('medForm').classList.remove('hidden');
      document.getElementById('manualToggleArrow').style.transform = 'rotate(180deg)';
    }

    // ‚îÄ‚îÄ Voice Input (State Machine) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let voiceState = 'IDLE';
    let currentTranscript = '';
    let currentParsedMed = null;
    let _mediaRecorder = null;
    let _audioChunks = [];
    let _recordingTimer = null;
    let _recordingSeconds = 0;

    function toggleRecording() {
      if (voiceState === 'RECORDING') {
        stopRecording();
      } else if (voiceState === 'IDLE' || voiceState === 'TRANSCRIPT_READY' || voiceState === 'PARSE_ERROR') {
        startRecording();
      }
    }

    async function startRecording() {
      if (voiceState === 'RECORDING') return;
      hideAllVoiceCards();
      voiceState = 'RECORDING';
      _audioChunks = [];
      _recordingSeconds = 0;

      // Update mic button to recording state
      const micBtn = document.getElementById('voiceMicBtn');
      micBtn.classList.remove('bg-secondary', 'mic-idle');
      micBtn.classList.add('bg-danger', 'mic-recording');
      document.getElementById('voiceHint').textContent = 'Listening... tap mic to stop';
      document.getElementById('voiceTimer').classList.remove('hidden');
      document.getElementById('voiceTimerSeconds').textContent = '0';

      // Start timer display
      _recordingTimer = setInterval(() => {
        _recordingSeconds++;
        document.getElementById('voiceTimerSeconds').textContent = _recordingSeconds;
        if (_recordingSeconds >= 15) stopRecording();
      }, 1000);

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        _mediaRecorder = new MediaRecorder(stream);
        _mediaRecorder.ondataavailable = e => _audioChunks.push(e.data);
        _mediaRecorder.onstop = async () => {
          stream.getTracks().forEach(t => t.stop());
          await handleRecordingComplete();
        };
        _mediaRecorder.start();
      } catch {
        resetVoiceState();
        const hint = document.getElementById('voiceHint');
        hint.textContent = 'Microphone access denied. Please allow permissions.';
        hint.classList.add('text-danger');
        setTimeout(() => {
          hint.textContent = 'Tap the mic and say your medication name';
          hint.classList.remove('text-danger');
        }, 4000);
      }
    }

    function stopRecording() {
      if (voiceState !== 'RECORDING' || !_mediaRecorder) return;
      clearInterval(_recordingTimer);
      document.getElementById('voiceTimer').classList.add('hidden');

      if (_recordingSeconds < 1) {
        if (_mediaRecorder.stream) _mediaRecorder.stream.getTracks().forEach(t => t.stop());
        resetVoiceState();
        document.getElementById('voiceHint').textContent = 'Hold a bit longer! Tap mic and speak.';
        return;
      }

      if (_mediaRecorder.state === 'recording') {
        _mediaRecorder.stop();
      }
    }

    async function handleRecordingComplete() {
      voiceState = 'TRANSCRIBING';
      const micBtn = document.getElementById('voiceMicBtn');
      micBtn.classList.remove('bg-danger', 'mic-recording');
      micBtn.classList.add('bg-gray-300');
      micBtn.disabled = true;
      document.getElementById('voiceHint').textContent = '';
      document.getElementById('voiceProcessing').classList.remove('hidden');
      document.getElementById('voiceProcessingText').textContent = 'Converting speech to text...';

      const blob = new Blob(_audioChunks, { type: 'audio/webm' });
      const reader = new FileReader();

      reader.onloadend = async () => {
        const base64 = reader.result.split(',')[1];
        try {
          const res = await fetch('/api/voice-to-med', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ audio: base64 }),
          });
          if (!res.ok) throw new Error('Transcription failed');
          const data = await res.json();
          currentTranscript = data.transcript || '';

          if (!currentTranscript.trim()) {
            resetVoiceState();
            document.getElementById('voiceHint').textContent = 'I didn\'t hear anything. Tap mic and try again.';
            return;
          }

          // Show transcript preview
          voiceState = 'TRANSCRIPT_READY';
          document.getElementById('voiceProcessing').classList.add('hidden');
          document.getElementById('transcriptText').textContent = currentTranscript;
          document.getElementById('transcriptPreview').classList.remove('hidden');
          resetMicButton();

        } catch (err) {
          console.error('Transcription error:', err);
          resetVoiceState();
          const hint = document.getElementById('voiceHint');
          hint.textContent = 'Transcription failed. Tap mic to try again.';
          hint.classList.add('text-danger');
          setTimeout(() => {
            hint.textContent = 'Tap the mic and say your medication name';
            hint.classList.remove('text-danger');
          }, 4000);
        }
      };
      reader.readAsDataURL(blob);
    }

    async function useTranscript() {
      if (!currentTranscript) return;
      voiceState = 'PARSING';
      document.getElementById('transcriptPreview').classList.add('hidden');
      document.getElementById('voiceProcessing').classList.remove('hidden');
      document.getElementById('voiceProcessingText').textContent = 'Understanding your medication...';

      try {
        const res = await fetch('/api/parse-medication', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ transcript: currentTranscript }),
        });
        if (!res.ok) throw new Error('Parse failed');
        const data = await res.json();

        if (!data.name || data.name.trim() === '') throw new Error('No medication name parsed');

        currentParsedMed = {
          name: data.name || '',
          dosage: data.dosage || '',
          condition: data.condition || '',
        };

        voiceState = 'REVIEW';
        document.getElementById('voiceProcessing').classList.add('hidden');
        showReviewCard(currentParsedMed);

      } catch (err) {
        console.error('Parse error:', err);
        voiceState = 'PARSE_ERROR';
        document.getElementById('voiceProcessing').classList.add('hidden');
        document.getElementById('parseErrorTranscript').textContent = currentTranscript;
        document.getElementById('parseErrorCard').classList.remove('hidden');
        resetMicButton();
      }
    }

    function showReviewCard(med) {
      document.getElementById('reviewName').textContent = med.name || '(none)';
      document.getElementById('reviewDosage').textContent = med.dosage || '(not specified)';

      const condRow = document.getElementById('reviewConditionRow');
      if (med.condition) {
        document.getElementById('reviewCondition').textContent = med.condition;
        condRow.classList.remove('hidden');
      } else { condRow.classList.add('hidden'); }

      document.getElementById('reviewCard').classList.remove('hidden');
      resetMicButton();
    }

    function goToSchedulePicker() {
      if (!currentParsedMed) return;
      document.getElementById('reviewCard').classList.add('hidden');
      showSchedulePicker(currentParsedMed.name);
    }

    function editFromReview() {
      document.getElementById('reviewCard').classList.add('hidden');
      document.getElementById('medName').value = currentParsedMed.name || '';
      document.getElementById('medDosage').value = currentParsedMed.dosage || '';
      expandManualForm();
      document.getElementById('medName').focus();
      voiceState = 'IDLE';
    }

    function typeInsteadFromError() {
      document.getElementById('parseErrorCard').classList.add('hidden');
      document.getElementById('medName').value = currentTranscript;
      expandManualForm();
      document.getElementById('medName').focus();
      voiceState = 'IDLE';
    }

    function retryVoice() {
      hideAllVoiceCards();
      resetVoiceState();
      setTimeout(() => startRecording(), 300);
    }

    function hideAllVoiceCards() {
      document.getElementById('transcriptPreview').classList.add('hidden');
      document.getElementById('reviewCard').classList.add('hidden');
      document.getElementById('parseErrorCard').classList.add('hidden');
      document.getElementById('schedulePicker').classList.add('hidden');
    }

    function resetMicButton() {
      const micBtn = document.getElementById('voiceMicBtn');
      micBtn.classList.remove('bg-danger', 'bg-gray-300', 'mic-recording');
      micBtn.classList.add('bg-secondary', 'mic-idle');
      micBtn.disabled = false;
    }

    function resetVoiceState() {
      voiceState = 'IDLE';
      currentTranscript = '';
      currentParsedMed = null;
      clearInterval(_recordingTimer);
      document.getElementById('voiceTimer').classList.add('hidden');
      document.getElementById('voiceProcessing').classList.add('hidden');
      const hint = document.getElementById('voiceHint');
      hint.textContent = 'Tap the mic and say your medication name';
      hint.classList.remove('text-danger', 'text-secondary');
      resetMicButton();
    }

    function showSuccessToast(medName) {
      const hint = document.getElementById('voiceHint');
      hint.textContent = `‚úì "${medName}" added!`;
      hint.classList.add('text-secondary');
      setTimeout(() => {
        hint.textContent = 'Tap the mic and say your medication name';
        hint.classList.remove('text-secondary');
      }, 3000);
    }

    // ‚îÄ‚îÄ Today's Medications / Adherence ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function getTodayKey() {
      const d = new Date();
      return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    }

    function getAdherenceLog() {
      return JSON.parse(localStorage.getItem('kaathu_adherence_' + getTodayKey()) || '{}');
    }

    function saveAdherenceLog(log) {
      localStorage.setItem('kaathu_adherence_' + getTodayKey(), JSON.stringify(log));
    }

    function calculateStatus(scheduledTime, medId) {
      const log = getAdherenceLog();
      const key = medId + '_' + scheduledTime;
      if (log[key]) {
        return { status: 'taken', takenAt: log[key].takenAt };
      }
      const now = new Date();
      const [h, m] = scheduledTime.split(':').map(Number);
      const scheduled = new Date(now);
      scheduled.setHours(h, m, 0, 0);
      const diffMin = (scheduled - now) / 60000; // positive = future, negative = past

      if (diffMin <= -15) return { status: 'overdue' };
      if (diffMin >= -15 && diffMin <= 15) return { status: 'due-now' };
      if (diffMin > 15 && diffMin <= 60) return { status: 'due-soon', minutes: Math.round(diffMin) };
      return { status: 'upcoming' };
    }

    function markAsTaken(medId, scheduledTime) {
      const log = getAdherenceLog();
      const key = medId + '_' + scheduledTime;
      log[key] = { status: 'taken', takenAt: new Date().toISOString() };
      saveAdherenceLog(log);
      renderTodayList();
    }

    function formatTime12h(time24) {
      const [h, m] = time24.split(':').map(Number);
      const ampm = h >= 12 ? 'PM' : 'AM';
      const h12 = h === 0 ? 12 : h > 12 ? h - 12 : h;
      return h12 + ':' + String(m).padStart(2, '0') + ' ' + ampm;
    }

    function renderTodayList() {
      // Set today's date header
      const today = new Date();
      document.getElementById('todayDate').textContent = today.toLocaleDateString('en-US', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });

      // Gather scheduled items and PRN-only meds separately
      const items = [];
      const prnOnlyMeds = [];
      medications.forEach(med => {
        const times = inferScheduledTimes(med);
        if (times.length > 0) {
          times.forEach(time => {
            const statusInfo = calculateStatus(time, med.id);
            items.push({ med, time, ...statusInfo });
          });
        } else if (med.asNeeded) {
          // PRN-only: no scheduled times but marked as-needed
          prnOnlyMeds.push(med);
        }
      });

      const container = document.getElementById('todayListContainer');
      const prnSection = document.getElementById('todayPrnSection');
      const prnContainer = document.getElementById('todayPrnContainer');
      const empty = document.getElementById('todayEmptyState');

      if (items.length === 0 && prnOnlyMeds.length === 0) {
        container.innerHTML = '';
        prnSection.classList.add('hidden');
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');

      // Render PRN-only meds
      if (prnOnlyMeds.length > 0) {
        prnSection.classList.remove('hidden');
        prnContainer.innerHTML = prnOnlyMeds.map(med => {
          const log = getAdherenceLog();
          const prnKey = med.id + '_prn';
          const taken = log[prnKey];
          const borderClass = taken ? 'border-secondary' : 'border-amber-400';
          const takenInfo = taken
            ? `<p class="text-xs text-secondary mt-1">(Taken at ${new Date(taken.takenAt).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })})</p>`
            : '';
          const actionBtn = !taken
            ? `<button onclick="markAsTaken(${med.id}, 'prn')" class="btn-touch mt-2 w-full bg-amber-500 text-white rounded-xl py-2 font-semibold text-base active:scale-95 transition">Take Now</button>`
            : '';
          return `
          <li class="bg-white rounded-2xl p-4 shadow-md border-l-4 ${borderClass}">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <p class="font-bold text-lg">${esc(med.name)}</p>
                ${med.condition ? `<p class="text-xs text-primary font-medium">${esc(med.condition)}</p>` : ''}
                <p class="text-ink/60 text-base">${esc(med.dosage)}</p>
                ${takenInfo}
              </div>
              <span class="ml-3 px-3 py-1 rounded-lg text-sm font-semibold whitespace-nowrap ${taken ? 'bg-secondary/10 text-secondary' : 'bg-amber-50 text-amber-600'}">
                ${taken ? '‚úì Taken' : 'üíä PRN'}
              </span>
            </div>
            ${actionBtn}
          </li>`;
        }).join('');
      } else {
        prnSection.classList.add('hidden');
      }

      if (items.length === 0) {
        container.innerHTML = '';
        return;
      }

      // Sort by scheduled time
      items.sort((a, b) => a.time.localeCompare(b.time));

      container.innerHTML = items.map(item => {
        let borderClass, badgeBg, badgeText, badgeLabel, icon;
        switch (item.status) {
          case 'taken':
            borderClass = 'border-secondary';
            badgeBg = 'bg-secondary/10'; badgeText = 'text-secondary';
            const takenTime = new Date(item.takenAt).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            badgeLabel = 'Taken';
            icon = '‚úì';
            break;
          case 'due-now':
            borderClass = 'border-amber-500';
            badgeBg = 'bg-amber-50'; badgeText = 'text-amber-700';
            badgeLabel = 'Due now';
            icon = '‚ö†Ô∏è';
            break;
          case 'due-soon':
            borderClass = 'border-amber-500';
            badgeBg = 'bg-amber-50'; badgeText = 'text-amber-700';
            badgeLabel = 'Due in ' + item.minutes + ' min';
            icon = '‚è≥';
            break;
          case 'overdue':
            borderClass = 'border-danger';
            badgeBg = 'bg-danger/10'; badgeText = 'text-danger';
            badgeLabel = 'Overdue';
            icon = '‚ùó';
            break;
          default: // upcoming
            borderClass = 'border-gray-300';
            badgeBg = 'bg-gray-100'; badgeText = 'text-ink/50';
            badgeLabel = 'Upcoming';
            icon = '‚è∞';
        }

        const takenInfo = item.status === 'taken'
          ? `<p class="text-xs text-secondary mt-1">(Taken at ${new Date(item.takenAt).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })})</p>`
          : '';

        const actionBtn = item.status !== 'taken'
          ? `<button onclick="markAsTaken(${item.med.id}, '${item.time}')" class="btn-touch mt-2 w-full bg-secondary text-white rounded-xl py-2 font-semibold text-base active:scale-95 transition">Mark as Taken</button>`
          : '';

        return `
        <li class="bg-white rounded-2xl p-4 shadow-md border-l-4 ${borderClass}">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <p class="font-bold text-lg">${esc(item.med.name)}</p>
              ${item.med.condition ? `<p class="text-xs text-primary font-medium">${esc(item.med.condition)}</p>` : ''}
              <p class="text-ink/60 text-base">${esc(item.med.dosage)} ‚Äî ${formatTime12h(item.time)}</p>
              ${takenInfo}
            </div>
            <span class="ml-3 px-3 py-1 rounded-lg text-sm font-semibold whitespace-nowrap ${badgeBg} ${badgeText}">${icon} ${badgeLabel}</span>
          </div>
          ${actionBtn}
        </li>`;
      }).join('');
    }

    // ‚îÄ‚îÄ QR Code ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function generateAndShowQR() {
      if (medications.length === 0) {
        alert('Add at least one medication before generating a QR code.');
        return;
      }

      // Check that the QR library loaded
      if (typeof QRCode === 'undefined') {
        alert('QR code library failed to load. Please check your internet connection and refresh.');
        return;
      }

      showScreen('screenQR');

      // Auto-check interactions if not cached
      if (cachedInteractions.length === 0 && medications.length >= 2) {
        checkAndDisplayInteractions();
      }

      // Build a compact payload
      const payload = {
        t: 'kaathu',
        v: 2,
        ts: Date.now(),
        m: medications.map(med => {
          const entry = { n: med.name, d: med.dosage };
          if (med.instructions) entry.i = med.instructions;
          if (med.condition) entry.c = med.condition;
          return entry;
        }),
      };

      // Include top 3 critical interactions (sorted by severity)
      if (cachedInteractions.length > 0) {
        const sorted = [...cachedInteractions].sort((a, b) => {
          const order = { Severe: 0, Moderate: 1, Mild: 2 };
          return (order[a.severity] || 2) - (order[b.severity] || 2);
        });
        payload.ix = sorted.slice(0, 3).map(i => ({
          p: i.pair,
          s: i.severity.charAt(0),
          d: i.description.substring(0, 100),
        }));
      }

      // Encode as a URL so any phone camera opens the emergency view directly
      const base64 = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
      // Use production Vercel URL for QR codes so they work when scanned on any device
      const prodUrl = 'https://kaathu.vercel.app';
      const origin = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
        ? prodUrl
        : window.location.origin;
      const baseUrl = origin + '/emergency.html';
      const qrData = baseUrl + '#' + base64;

      const canvas = document.getElementById('qrCanvas');
      QRCode.toCanvas(canvas, qrData, {
        width: 280,
        margin: 2,
        errorCorrectionLevel: 'L',
        color: { dark: '#0f172a', light: '#ffffff' },
      }, function(err) {
        if (err) {
          console.error('QR generation failed:', err);
          // Fallback: try with just medication names and dosages (smaller payload)
          const minimal = {
            t: 'kaathu',
            v: 1,
            m: medications.map(med => ({ n: med.name, d: med.dosage })),
          };
          const minBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(minimal))));
          QRCode.toCanvas(canvas, baseUrl + '#' + minBase64, {
            width: 280,
            margin: 2,
            errorCorrectionLevel: 'L',
            color: { dark: '#0f172a', light: '#ffffff' },
          }, function(err2) {
            if (err2) {
              alert('Too many medications for a single QR code. Try removing some entries.');
            }
          });
        }
      });
    }

    // ‚îÄ‚îÄ Drug Interactions (QR screen) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function checkInteractions() {
      if (medications.length < 2) {
        alert('Add at least two medications to check for interactions.');
        return;
      }

      // Use cached data if available
      if (cachedInteractions.length > 0) {
        displayInteractionsOnQRScreen();
        return;
      }

      showLoading('Checking interactions...');
      try {
        await checkAndDisplayInteractions();
        displayInteractionsOnQRScreen();
      } catch (err) {
        alert('Could not check interactions. Please try again.');
        console.error(err);
      } finally {
        hideLoading();
      }
    }

    function displayInteractionsOnQRScreen() {
      const body = document.getElementById('interactionsBody');
      if (cachedInteractions.length === 0) {
        body.innerHTML = '<p class="text-secondary font-semibold">No known interactions found.</p>';
      } else {
        body.innerHTML = cachedInteractions.map(i => {
          const sevColor = i.severity === 'Severe' ? 'text-danger' :
                           i.severity === 'Moderate' ? 'text-yellow-700' : 'text-ink/60';
          return `<div class="py-2 border-b last:border-0">
            <p class="font-semibold ${sevColor}">${esc(i.pair)}</p>
            <p class="text-ink/70">${esc(i.description)}</p>
            <p class="text-sm text-ink/50">Severity: ${esc(i.severity)}</p>
          </div>`;
        }).join('');
      }
      document.getElementById('interactionsResult').classList.remove('hidden');
    }

    // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showLoading(text) {
      document.getElementById('loadingText').textContent = text || 'Processing...';
      document.getElementById('loadingOverlay').classList.remove('hidden');
    }
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.add('hidden');
    }
    function esc(str) {
      const el = document.createElement('span');
      el.textContent = str;
      return el.innerHTML;
    }

    // ‚îÄ‚îÄ PWA Registration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }

    // ‚îÄ‚îÄ Pre-fetch condition when typing drug name (debounced AI lookup) ‚îÄ‚îÄ
    // Condition is auto-detected and shown on flash card ‚Äî no text box needed
    let _conditionDebounce = null;
    document.getElementById('medName').addEventListener('input', function() {
      const drugName = this.value.trim();
      if (!drugName) return;
      // Check cache first (instant)
      const cached = lookupCondition(drugName);
      if (cached) return; // already cached
      // Debounce the API call ‚Äî wait 600ms after user stops typing
      clearTimeout(_conditionDebounce);
      _conditionDebounce = setTimeout(async () => {
        await fetchCondition(drugName);
      }, 600);
    });

    // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    renderMedList();

    // Load cached interactions on startup
    cachedInteractions = loadCachedInteractions();
    renderInteractionSummary();
    if (medications.length >= 2 && cachedInteractions.length === 0) {
      checkAndDisplayInteractions();
    }

    // Backfill conditions for existing medications from AI (background)
    const _medsNeedingCondition = medications.filter(m => !m.condition).map(m => m.name);
    if (_medsNeedingCondition.length > 0) {
      fetchConditions(_medsNeedingCondition).then(() => {
        let updated = false;
        medications.forEach(m => {
          if (!m.condition) {
            const cond = lookupCondition(m.name);
            if (cond) { m.condition = cond; updated = true; }
          }
        });
        if (updated) { saveMeds(); renderMedList(); }
      });
    }
  </script>
</body>
</html>
